#!/bin/bash

## change into signal directory
SOURCE="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd $SOURCE

for RECIPIENT in $(ls queue)
do
  while read MESSAGE
  do
    logger "re-sending \"$MESSAGE\" to $RECIPIENT"
    ./signal -to=$RECIPIENT -message="queued: $MESSAGE"
    REGEX=$(printf '%q' "$MESSAGE")
    sed -i '/^'"$REGEX"'/d' queue/$RECIPIENT
  done < queue/$(echo $RECIPIENT)
done
